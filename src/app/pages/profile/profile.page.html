<app-navbar title="Profil">

  @if (user) {
  <button right type="button" class="btn-small btn-neutral" (click)="editChangeCommunityPopup(true)">
    <lucide-icon [img]="userPen"></lucide-icon>
  </button>
  }
</app-navbar>

@if (user) {
<div class="grid gap-4">
  <div class="flex justify-center">
    <img class="profile-image clickable rounded-full" [src]="user.profileimage" alt="" width="100" height="100"
      (click)="editImage(true)" />
  </div>


  <div class="flex justify-center">
    <h2 class="clickable text-xl font-semibold" (click)="toggleNameEditor()">
      {{user?.name}}
    </h2>
  </div>

  @if (!user.communities) {
  <div class="card p-4 text-center">
    <p>Noch keiner Gemeinschaft beigetreten</p>
    <div class="grid grid-cols-2 gap-4 mt-4">
      <button class="btn-large btn-primary w-full" (click)="gotoFindCommunity()">Beitreten</button>
      <button class="btn-large btn-outline-primary w-full" (click)="gotoCreateCommunity()">Erstellen</button>
    </div>
  </div>
  }

  @if (community) {
  <div class="grid grid-cols-2 gap-4">
    <div class="card text-center p-4">
      <h2 class="text-lg font-semibold">{{community?.name}}</h2>
      <p class="text-sm">Gemeinschaft</p>
    </div>
    <div class="card text-center p-4">
      <h2 class="text-lg font-semibold">{{community?.code}}</h2>
      <p class="text-sm">Beitrittscode</p>
    </div>
  </div>
  }

  @if (usersInCommunity.length) {
  <div class="card p-4">
    <p class="text-center mb-4">Mitglieder</p>
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-9 gap-2 justify-items-center">
      @for (user of usersInCommunity; track user) {
      <div class="card w-full text-center">
        <img [src]="user.profileimage" alt="" class="rounded-full w-full aspect-square object-cover mb-2" />
        <p class="text-sm lg:text-lg">{{user?.name}}</p>
        @if(user.isAdmin) {
        <span class="text-xs text-primary">Admin</span>
        }
      </div>
      }
    </div>
  </div>
  }

  <div class="grid grid-cols-2 gap-4">
    @if (community) {
    <div class="card flex justify-center items-center clickable p-4" (click)="editColor(true)">
      <p class="mr-2">Meine Farbe</p>
      <lucide-icon [ngStyle]="{'color': user.color}" [img]="paletteIcon"></lucide-icon>
    </div>
    }
    <div class="card flex justify-center items-center clickable p-4" (click)="openLogoutPopup()">
      <p class="mr-2">Abmelden</p>
    </div>
  </div>

  @if (user.isAdmin) {
  <app-open-requests />
  }
</div>
}

<app-popup [show]="editingColor" (close)="editingColor = false" title="Farbe auswählen">
  <app-color-editor (closeEditor)="editColor(false)" />
</app-popup>

<app-popup [show]="editingName" (close)="editingName = false" title="Name ändern">
  <div class="p-4">

    <form class="flex gap-2 mb-3 w-full" [formGroup]="nameUpdateEditorForm" (ngSubmit)="updateName()">
      <input type="text" id="name" autocomplete="off" formControlName="name" placeholder="Name" class="flex-1" />
    </form>

    <button type="button" [disabled]="nameUpdateEditorForm.invalid || (name.value === user?.name)"
      (click)="updateName()" class="btn-large btn-primary flex-1">Updaten</button>
  </div>
</app-popup>

<app-popup [show]="editingImage" (close)="editingImage = false" title="Bild auswählen">
  <app-profile-image-editor (closeEditor)="editImage(false)" />
</app-popup>

<app-popup [show]="changeCommunityPopup" (close)="changeCommunityPopup = false" title="Deine Communities">
  @if (user) {
  <div class="flex flex-col gap-2">

    @for (community of user.communities; track community) {
    @if (community.id == this.community.id) {
    <div class="card px-6 py-3 flex flex-row justify-between bg-primary/20">
      {{community?.name}}
    </div>
    } @else {
    <div class="card px-6 py-3 flex flex-row justify-between clickable" (click)="selectCommunity(community.id)">
      {{community?.name}}
      <lucide-icon [img]="switchIcon"></lucide-icon>
    </div>
    }
    }
  </div>

  <button class="btn-small btn-primary flex-1 w-full mt-6" (click)="gotoOnboarding()">Community erstellen /
    beitreten</button>

  }
</app-popup>

<app-confirmation-popup *ngIf="showLogoutPopup" title="Abmelden" content="Bist du dir sicher?" submitText="Abmelden"
  [isDanger]="true" [hasAbortButton]="true" (abort)="showLogoutPopup = false"
  (submit)="logout()"></app-confirmation-popup>
